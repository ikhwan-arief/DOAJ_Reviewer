name: Run DOAJ Reviewer

on:
  workflow_dispatch:
    inputs:
      submission_path:
        description: Path to submission JSON file in this repository
        required: true
        default: examples/submission.example.json
      input_mode:
        description: Submission mode
        required: true
        default: structured
        type: choice
        options:
          - raw
          - structured
      js_mode:
        description: JS rendering mode (used when input_mode=raw)
        required: true
        default: auto
        type: choice
        options:
          - off
          - auto
          - on
      enable_playwright:
        description: Install Playwright + Chromium before review
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      issue_number:
        description: Optional GitHub issue number to post report comment
        required: false
        default: ""

permissions:
  contents: read
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Optional Playwright install
        if: ${{ github.event.inputs.enable_playwright == 'true' }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install playwright
          python -m playwright install chromium

      - name: Build submission and run reviewer
        env:
          PYTHONPATH: src
        run: |
          mkdir -p artifacts
          if [ "${{ github.event.inputs.input_mode }}" = "raw" ]; then
            python -m doaj_reviewer.intake \
              --input "${{ github.event.inputs.submission_path }}" \
              --output artifacts/submission.structured.json \
              --js-mode "${{ github.event.inputs.js_mode }}"
          else
            cp "${{ github.event.inputs.submission_path }}" artifacts/submission.structured.json
          fi
          python -m doaj_reviewer.review \
            --submission artifacts/submission.structured.json \
            --summary-json artifacts/review-summary.json \
            --summary-md artifacts/review-summary.md \
            --endogeny-json artifacts/endogeny-result.json \
            --endogeny-md artifacts/endogeny-report.md

      - name: Upload review artifacts
        uses: actions/upload-artifact@v4
        with:
          name: doaj-review-report
          path: artifacts/

      - name: Comment report to issue
        if: ${{ github.event.inputs.issue_number != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issueNumber = Number('${{ github.event.inputs.issue_number }}');
            if (!Number.isInteger(issueNumber) || issueNumber <= 0) {
              core.setFailed('issue_number must be a positive integer');
              return;
            }
            const summary = fs.readFileSync('artifacts/review-summary.md', 'utf8');
            const endogeny = fs.readFileSync('artifacts/endogeny-report.md', 'utf8');
            const body = `${summary}\n\n<details><summary>Endogeny detail</summary>\n\n${endogeny}\n\n</details>`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body
            });
